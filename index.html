<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propuesta de Juego - Carga y Galería</title>
    
    <!-- Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Favicon de la aplicación -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon.ico" type="image/x-icon">
    
    <!-- Google Fonts para una tipografía agradable -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Generales */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a192f; /* Un azul marino oscuro más profesional */
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            cursor: pointer;
        }
        .nav-link:hover {
            color: #64ffda; /* Color cian para resaltar */
        }
        .nav-link.active {
            color: #64ffda;
            border-bottom: 2px solid #64ffda;
        }
        /* Estilos para el visor de imágenes */
        #image-viewer {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        #image-viewer.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: all;
        }
        #viewer-img {
            cursor: grab;
            transition: transform 0.2s ease-out;
        }
        #viewer-img.dragging {
            cursor: grabbing;
        }
        /* Animación del Caballero en la Barra de Carga */
        @keyframes knight-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        #knight-icon {
            animation: knight-bob 1s ease-in-out infinite;
            transition: left 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- Encabezado de Navegación (se muestra después de la carga) -->
    <nav id="main-nav" class="bg-gray-900/80 backdrop-blur-sm shadow-md fixed top-0 w-full z-20 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/logofundacion.jpg" alt="Logo" class="h-10 w-10 rounded-full">
                    <span class="text-white font-semibold text-xl ml-3">Propuesta de Juego</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a id="nav-inicio" class="nav-link px-3 py-2 text-sm font-medium">Inicio</a>
                        <a id="nav-galeria" class="nav-link px-3 py-2 text-sm font-medium">Galería del Juego</a>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Abrir menú principal</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a id="mobile-nav-inicio" class="text-cyan-400 bg-gray-900 block px-3 py-2 rounded-md text-base font-medium">Inicio</a>
                <a id="mobile-nav-galeria" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Galería del Juego</a>
            </div>
        </div>
    </nav>
    
    <!-- SECCIÓN DE CARGA DE RECURSOS -->
    <section id="loading-section" class="flex items-center justify-center min-h-screen">
        <div class="max-w-2xl w-full mx-auto p-8 text-center bg-gray-800 rounded-2xl shadow-lg m-4">
            <h1 class="text-4xl font-bold text-cyan-400 mb-4">Preparando el Campo de Batalla</h1>
            <p id="loading-text" class="text-lg text-gray-300 mb-8 leading-relaxed">
                Verificando componentes del juego...
            </p>
            <!-- Barra de Progreso Temática -->
            <div id="progress-container" class="w-full max-w-md mx-auto hidden">
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between text-xs">
                        <div>
                            <span class="font-semibold inline-block text-cyan-400">
                                Castillo Aliado
                            </span>
                        </div>
                        <div class="text-right">
                             <span class="font-semibold inline-block text-red-400">
                                Fortaleza Enemiga
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-gray-700 border border-gray-600">
                        <div id="loading-progress-bar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500 transition-all duration-500"></div>
                    </div>
                    <!-- Icono del Caballero -->
                    <div id="knight-icon" class="absolute left-0 top-full -mt-1 w-8 h-8" style="left: 0%;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-full h-full drop-shadow-lg">
                            <path d="M5.562 15.344l1.25-1.25a1.25 1.25 0 0 1 1.768 0l2.437 2.438 2.204-4.85c.216-.475.66-.804 1.18-.882l3.125-.468a.5.5 0 0 1 .53.645l-1 3a.5.5 0 0 1-.645.34l-2.03-.304-2.812 6.187a1.25 1.25 0 0 1-2.242 0L5.563 17.11a1.25 1.25 0 0 1 0-1.768zM14.5 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2zM18 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-2 2.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
             <div class="mt-12">
                <button id="clear-cache-btn" class="text-xs bg-gray-700 text-gray-400 font-bold py-1 px-3 rounded-md hover:bg-red-700 hover:text-white transition duration-300 shadow-sm">
                    Limpiar Caché
                </button>
            </div>
        </div>
    </section>

    <!-- SECCIÓN DE INICIO (APK) -->
    <section id="home-section" class="hidden items-center justify-center min-h-screen pt-16">
        <div class="max-w-2xl w-full mx-auto p-8 text-center bg-gray-800 rounded-2xl shadow-lg m-4">
            <header class="mb-8">
                <img src="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/logofundacion.jpg" alt="Logo de la Fundación" class="w-32 h-32 mx-auto rounded-full object-cover shadow-md border-4 border-cyan-500">
            </header>
            <main>
                <h1 class="text-4xl font-bold text-cyan-400 mb-4">¡Versión de Prueba Disponible!</h1>
                <p class="text-lg text-gray-300 mb-8 leading-relaxed">
                    Puedes probar una versión preliminar del juego descargando el APK directamente en tu dispositivo móvil.
                </p>
                <a href="https://github.com/instructorandradedcc/propuesta-AR/raw/main/Propuesta_Salud_AR_v1.0.0.apk" 
                   class="inline-block bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-4 px-8 rounded-lg text-xl transition-transform duration-300 transform hover:scale-105 shadow-lg"
                   download>
                    Descargar APK de Prueba
                </a>
                <p class="text-md text-gray-400 mt-8">
                    Usa el APK con los personajes y objetos que encontrarás en la 
                    <a id="link-a-galeria" class="text-cyan-400 hover:underline font-semibold cursor-pointer">siguiente página</a>.
                </p>
                <p class="text-sm text-gray-500 mt-6">
                    Recuerda habilitar "Instalar desde fuentes desconocidas" en los ajustes de tu celular.
                </p>
                <div class="mt-10">
                    <button id="btn-siguiente-pagina"
                       class="inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-300 transform hover:scale-105 shadow-lg">
                        Ver Galería &rarr;
                    </button>
                </div>
            </main>
        </div>
    </section>

    <!-- SECCIÓN DE GALERÍA -->
    <section id="gallery-section" class="hidden container mx-auto px-4 py-24">
        <h1 class="text-4xl font-bold text-center text-cyan-400 mb-4">Galería del Juego</h1>
        <p class="text-center text-lg text-gray-400 mb-12">Haz clic en cualquier imagen para verla en detalle. Estos son los personajes y objetos que encontrarás en el juego.</p>
        <div id="image-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Las imágenes se insertarán aquí con JS -->
        </div>
    </section>

    <!-- Visor de Imágenes a Pantalla Completa -->
    <div id="image-viewer" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <button id="close-viewer" class="absolute top-5 right-5 text-white text-4xl hover:text-cyan-400 transition">&times;</button>
        <button id="prev-img" class="absolute left-5 text-white text-5xl hover:text-cyan-400 transition">&#8249;</button>
        <button id="next-img" class="absolute right-5 text-white text-5xl hover:text-cyan-400 transition">&#8250;</button>
        <div class="w-full h-full flex items-center justify-center overflow-hidden">
             <img id="viewer-img" src="" alt="Vista ampliada" class="max-w-[90%] max-h-[90%] object-contain">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = '1.1'; // ¡Incrementa esta versión para forzar una actualización!
            const CACHE_NAME = `game-assets-cache-v${APP_VERSION}`;
            const imageUrls = [
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/cabeza1.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/corazon.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/dedo-mano.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/dedo.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/hueso-columna.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/huesosmano.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/mano-iz-protesis.png',
                'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/imagenes/protesis-mano-brazo.png'
            ];

            // --- ELEMENTOS DEL DOM ---
            const loadingSection = document.getElementById('loading-section');
            const homeSection = document.getElementById('home-section');
            const gallerySection = document.getElementById('gallery-section');
            const mainNav = document.getElementById('main-nav');
            const clearCacheBtn = document.getElementById('clear-cache-btn');
            const loadingText = document.getElementById('loading-text');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('loading-progress-bar');
            const knightIcon = document.getElementById('knight-icon');

            // --- LÓGICA DE CARGA Y CACHÉ ---
            async function loadAndCacheAssets() {
                progressContainer.classList.remove('hidden');
                clearCacheBtn.disabled = true;
                progressBar.style.width = '0%';
                knightIcon.style.left = '0%';
                let loadedCount = 0;

                try {
                    // Limpiar cachés de versiones antiguas para forzar la actualización.
                    // Si cambias APP_VERSION, este código eliminará la caché vieja.
                    const keys = await caches.keys();
                    for (const key of keys) {
                        if (key !== CACHE_NAME && key.startsWith('game-assets-cache')) {
                            await caches.delete(key);
                        }
                    }

                    const cache = await caches.open(CACHE_NAME);
                    for (const url of imageUrls) {
                        loadingText.textContent = `Descargando componente ${loadedCount + 1} de ${imageUrls.length}...`;
                        const response = await fetch(url, { mode: 'cors' });
                        if (!response.ok) throw new Error(`Fallo al descargar: ${url}`);
                        await cache.put(url, response);
                        loadedCount++;
                        const percentage = (loadedCount / imageUrls.length) * 100;
                        progressBar.style.width = `${percentage}%`;
                        knightIcon.style.left = `calc(${percentage}% - 16px)`; // Ajustar posición del ícono
                    }
                    loadingText.textContent = '¡Componentes listos!';
                    setTimeout(initializeApp, 1000);
                } catch (error) {
                    loadingText.textContent = 'Error al descargar componentes. Intenta de nuevo.';
                    progressBar.style.backgroundColor = 'red';
                    console.error('Error en la carga:', error);
                    clearCacheBtn.disabled = false;
                }
            }

            async function clearCacheAndReload() {
                try {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(key => {
                         if (key.startsWith('game-assets-cache')) {
                            return caches.delete(key);
                        }
                    }));
                    alert('Caché limpiada. La página se recargará.');
                    window.location.reload();
                } catch (error) {
                    alert('Error al limpiar la caché.');
                    console.error('Error al limpiar caché:', error);
                }
            }
            
            async function checkCache() {
                try {
                    const cache = await caches.open(CACHE_NAME);
                    const cachedResponses = await Promise.all(imageUrls.map(url => cache.match(url)));
                    // Verifica que CADA asset esté en la caché. Si añades un nuevo asset a la lista, 
                    // esta función devolverá falso y forzará una nueva descarga.
                    return cachedResponses.every(response => response && response.ok);
                } catch (error) {
                    console.warn("No se pudo verificar la caché:", error);
                    return false;
                }
            }

            // --- INICIALIZACIÓN DE LA APP ---
            function initializeApp() {
                loadingSection.classList.add('hidden');
                mainNav.classList.remove('hidden');
                showHome();
                populateGallery();
            }

            async function startup() {
                // Paso 1: Revisar si los componentes de la versión actual ya están en caché.
                const assetsInCache = await checkCache();
                
                // Paso 2: Decidir la acción basada en si los assets están cacheados.
                if (assetsInCache) {
                    // Si ya están descargados, inicia el juego directamente.
                    loadingText.textContent = "¡Componentes del juego encontrados! Iniciando partida...";
                    setTimeout(initializeApp, 1500);
                } else {
                    // Si no están descargados (o si la APP_VERSION cambió), los descarga automáticamente.
                    loadingText.textContent = "Se necesitan nuevos componentes. Iniciando descarga...";
                    setTimeout(loadAndCacheAssets, 1000);
                }
            }
            
            clearCacheBtn.addEventListener('click', clearCacheAndReload);
            
            // Inicia el proceso de verificación en cuanto la página carga.
            startup();

            // --- MANEJO DE VISTAS (PÁGINAS) ---
            const navInicio = document.getElementById('nav-inicio');
            const navGaleria = document.getElementById('nav-galeria');
            const mobileNavInicio = document.getElementById('mobile-nav-inicio');
            const mobileNavGaleria = document.getElementById('mobile-nav-galeria');

            function showHome() {
                homeSection.classList.remove('hidden');
                homeSection.classList.add('flex');
                gallerySection.classList.add('hidden');
                navInicio.classList.add('active');
                navGaleria.classList.remove('active');
                mobileNavInicio.classList.add('text-cyan-400', 'bg-gray-900');
                mobileNavGaleria.classList.remove('text-cyan-400', 'bg-gray-900');
                window.scrollTo(0, 0);
            }

            function showGallery() {
                homeSection.classList.add('hidden');
                homeSection.classList.remove('flex');
                gallerySection.classList.remove('hidden');
                navInicio.classList.remove('active');
                navGaleria.classList.add('active');
                mobileNavInicio.classList.remove('text-cyan-400', 'bg-gray-900');
                mobileNavGaleria.classList.add('text-cyan-400', 'bg-gray-900');
                window.scrollTo(0, 0);
            }
            
            // Eventos de navegación
            navInicio.addEventListener('click', showHome);
            navGaleria.addEventListener('click', showGallery);
            mobileNavInicio.addEventListener('click', showHome);
            mobileNavGaleria.addEventListener('click', showGallery);
            document.getElementById('link-a-galeria').addEventListener('click', showGallery);
            document.getElementById('btn-siguiente-pagina').addEventListener('click', showGallery);

            // --- LÓGICA DE LA GALERÍA ---
            const gallery = document.getElementById('image-gallery');
            const imageViewer = document.getElementById('image-viewer');
            const viewerImg = document.getElementById('viewer-img');
            
            let currentIndex = 0;
            let galleryPopulated = false;

            function populateGallery() {
                if(galleryPopulated) return;
                imageUrls.forEach((url, index) => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300 cursor-pointer';
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Imagen de galería ${index + 1}`;
                    img.className = 'w-full h-48 object-cover';
                    img.dataset.index = index;
                    galleryItem.appendChild(img);
                    gallery.appendChild(galleryItem);
                });
                galleryPopulated = true;
            }

            // --- Funcionalidad del Visor ---
            const openViewer = (index) => {
                currentIndex = parseInt(index);
                viewerImg.src = imageUrls[currentIndex];
                resetZoom();
                imageViewer.classList.add('open');
            };

            const closeViewer = () => imageViewer.classList.remove('open');
            const showPrevImage = () => {
                currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
                viewerImg.src = imageUrls[currentIndex];
                resetZoom();
            };
            const showNextImage = () => {
                currentIndex = (currentIndex + 1) % imageUrls.length;
                viewerImg.src = imageUrls[currentIndex];
                resetZoom();
            };
            
            // Event Listeners del Visor
            gallery.addEventListener('click', (e) => e.target.tagName === 'IMG' && openViewer(e.target.dataset.index));
            document.getElementById('close-viewer').addEventListener('click', closeViewer);
            document.getElementById('prev-img').addEventListener('click', showPrevImage);
            document.getElementById('next-img').addEventListener('click', showNextImage);
            document.addEventListener('keydown', (e) => {
                if (imageViewer.classList.contains('open')) {
                    if (e.key === 'Escape') closeViewer();
                    if (e.key === 'ArrowLeft') showPrevImage();
                    if (e.key === 'ArrowRight') showNextImage();
                }
            });
            imageViewer.addEventListener('click', (e) => e.target === imageViewer && closeViewer());

            // --- Funcionalidad de Zoom y Arrastre ---
            let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 }, isRightClickDown = false;
            const setTransform = () => viewerImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            const resetZoom = () => { scale = 1; pointX = 0; pointY = 0; setTransform(); };
            viewerImg.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (e.button === 2) { isRightClickDown = true; viewerImg.style.cursor = 'ns-resize'; } 
                else { panning = true; start = { x: e.clientX - pointX, y: e.clientY - pointY }; viewerImg.classList.add('dragging'); }
            });
            viewerImg.addEventListener('mouseup', (e) => {
                if(e.button === 2) { isRightClickDown = false; viewerImg.style.cursor = 'grab'; }
                panning = false; viewerImg.classList.remove('dragging');
            });
            viewerImg.addEventListener('mousemove', (e) => {
                e.preventDefault();
                if (panning) { pointX = e.clientX - start.x; pointY = e.clientY - start.y; setTransform(); }
            });
            viewerImg.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (isRightClickDown || e.ctrlKey) {
                    const xs = (e.clientX - pointX) / scale, ys = (e.clientY - pointY) / scale;
                    scale *= (e.deltaY > 0) ? 0.9 : 1.1;
                    pointX = e.clientX - xs * scale;
                    pointY = e.clientY - ys * scale;
                    setTransform();
                }
            });
            viewerImg.addEventListener('contextmenu', e => e.preventDefault());

            // --- Funcionalidad Táctil (Swipe y Pinch-to-Zoom) ---
            let initialDistance = null, touchStartX = 0;
            const getDistance = (t) => Math.hypot(t[0].pageX - t[1].pageX, t[0].pageY - t[1].pageY);
            viewerImg.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) initialDistance = getDistance(e.touches);
                else if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    start = { x: e.touches[0].clientX - pointX, y: e.touches[0].clientY - pointY };
                    panning = true;
                }
            });
            viewerImg.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 2 && initialDistance) {
                    scale *= getDistance(e.touches) / initialDistance;
                    initialDistance = getDistance(e.touches);
                    setTransform();
                } else if (e.touches.length === 1 && panning) {
                    pointX = e.touches[0].clientX - start.x;
                    pointY = e.touches[0].clientY - start.y;
                    setTransform();
                }
            });
            viewerImg.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) initialDistance = null;
                if (e.touches.length < 1) {
                    panning = false;
                    const swipeDist = e.changedTouches[0].clientX - touchStartX;
                    if (Math.abs(swipeDist) > 50) swipeDist > 0 ? showPrevImage() : showNextImage();
                }
            });

            // --- MENÚ MÓVIL ---
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const icons = mobileMenuButton.querySelectorAll('svg');
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                icons.forEach(icon => icon.classList.toggle('hidden'));
            });
        });
    </script>
</body>
</html>










