<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <!-- CORREGIDO: user-scalable=no para evitar zoom accidental en m√≥viles -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ajedrez AR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        /* Estilos generales y para el modo AR */
        html.ar-active, body.ar-active {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .screen {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transition: opacity 0.5s ease-in-out;
            z-index: 10;
        }
        .screen.active { display: flex; }
        .selection-card, .board-card, .color-swatch, .mode-card {
            transition: all 0.3s ease;
            border: 4px solid transparent;
        }
        .selection-card.selected, .board-card.selected, .color-swatch.selected, .mode-card.selected {
            border-color: #FBBF24;
            transform: scale(1.05);
        }
        #ar-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
        }
        .version {
            position: fixed; bottom: 10px; right: 10px;
            color: #9ca3af; font-size: 0.8rem; z-index: 100;
        }
        .game-status {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 10px 20px; border-radius: 20px;
            z-index: 100; font-size: 1.2rem; display: none;
        }
        /* Estilos de ECOPIENSA integrados */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #scanning-ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9991; display: flex;
            justify-content: center; align-items: center;
            pointer-events: none; background-color: rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        }
        #scanning-ui.hidden { opacity: 0; pointer-events: none; }
        .scan-text {
            padding: 8px 16px; background-color: rgba(0,0,0,0.6);
            color: white; font-size: 1.1rem; border-radius: 8px;
        }
    </style>
</head>
<body class="bg-stone-900 text-white overflow-hidden">
    <div id="app-version" class="version"></div>
    <div id="game-status" class="game-status"></div>

    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="screen active flex-col justify-center items-center text-center p-8 bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://placehold.co/1200x800/1c1917/f5f5f4?text=Ajedrez+AR');">
        <h1 class="text-5xl md:text-7xl font-extrabold mb-4 text-amber-300 drop-shadow-lg">Ajedrez en Realidad Aumentada</h1>
        <p class="text-lg md:text-xl max-w-2xl mb-8 text-stone-200">Vive la magia del ajedrez con piezas en 3D en tu propio entorno.</p>
        <button id="start-btn" class="bg-amber-400 text-stone-900 font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:bg-amber-300 transition-transform transform hover:scale-105">Empezar</button>
    </div>

    <!-- Pantalla de Selecci√≥n de Set de Piezas -->
    <div id="selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-bold mb-2 text-amber-300">Selecciona tu Set</h2>
            <p class="text-stone-300">Elige el estilo de piezas para tu partida.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="harry-potter">
                <div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßô‚Äç‚ôÇÔ∏è</div>
                <h3 class="text-2xl font-semibold mb-2">Wizard's Chess</h3>
                <p class="text-stone-400">Piezas inspiradas en el ajedrez m√°gico.</p>
            </div>
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="futuristic">
                <div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center"><span class="text-8xl">‚ôú</span></div>
                <h3 class="text-2xl font-semibold mb-2">Futurista</h3>
                <p class="text-stone-400">Dise√±o moderno y disruptivo (primitivas).</p>
            </div>
        </div>
        <button id="continue-set-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 transition-all shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
    </div>

    <!-- Pantalla de Selecci√≥n de Tablero y Colores -->
    <div id="board-selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10">
             <h2 class="text-4xl font-bold mb-2 text-amber-300">Personaliza tu Partida</h2>
             <p class="text-stone-300">Elige tu tablero y el color de tus piezas.</p>
        </div>
        <div class="max-w-4xl w-full">
            <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige un tablero</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-wood"><img src="https://placehold.co/400x300/854d0e/fefce8?text=Madera+Cl√°sica" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de madera cl√°sica"><p>Madera Cl√°sica</p></div>
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-marble"><img src="https://placehold.co/400x300/d1d5db/1f2937?text=M√°rmol+Elegante" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de m√°rmol elegante"><p>M√°rmol Elegante</p></div>
            </div>
             <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige el color de tus piezas</h3>
            <div class="flex justify-center gap-6">
                <div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-white" data-color="w"></div>
                <div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-gray-800" data-color="b"></div>
            </div>
        </div>
        <button id="continue-board-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
        <button id="back-to-set-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <!-- Pantalla de Selecci√≥n de Modo de Juego -->
    <div id="game-mode-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10">
             <h2 class="text-4xl font-bold mb-2 text-amber-300">Modo de Juego</h2>
             <p class="text-stone-300">¬øC√≥mo quieres jugar?</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pva">
                <div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">ü§ñ</div>
                <h3 class="text-2xl font-semibold">Jugador vs. M√°quina</h3>
            </div>
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pvp">
                <div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßë‚Äçü§ù‚Äçüßë</div>
                <h3 class="text-2xl font-semibold">Jugador vs. Jugador</h3>
            </div>
        </div>
        <button id="start-game-btn" class="mt-12 bg-green-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-green-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Iniciar Partida</button>
        <button id="back-to-board-select-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <!-- Pantalla de AR -->
    <div id="ar-screen" class="screen flex-col justify-center items-center bg-transparent">
        <div id="ar-container"></div> <!-- Contenedor principal de A-Frame -->
        <!-- UI superpuesta sobre la vista AR -->
        <div id="ar-ui-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none">
            <button id="back-to-mode-btn" class="absolute top-5 left-5 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600 z-30 pointer-events-auto" style="display: none;">Salir</button>
            <div id="scanning-ui" class="hidden">
                <p class="scan-text">Apunte al marcador</p>
            </div>
        </div>
    </div>
    
    <!-- Overlays de Carga -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 text-amber-200 flex flex-col items-center justify-center" style="display: none; z-index: 50;">
        <div class="loader mb-4"></div>
        <p id="loading-message" class="text-lg">Cargando modelos 3D...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.12.0/chess.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Cada vez que se realice una correcci√≥n o actualizaci√≥n, esta versi√≥n debe ser incrementada.
            const APP_VERSION = "1.5.0"; // Versi√≥n actualizada para reflejar las correcciones.

            // Game state variables
            let game = new Chess();
            let gameState = 'IDLE'; // IDLE, PIECE_SELECTED
            let selectedPieceEntity = null;
            let legalMoveEntities = [];
            let playerColor = 'w';
            let gameMode = 'pva'; // pvp, pva
            
            // UI Elements
            const screens = {
                welcome: document.getElementById('welcome-screen'),
                selection: document.getElementById('selection-screen'),
                boardSelection: document.getElementById('board-selection-screen'),
                gameMode: document.getElementById('game-mode-screen'),
                ar: document.getElementById('ar-screen'),
            };
            const buttons = {
                start: document.getElementById('start-btn'),
                continueSet: document.getElementById('continue-set-btn'),
                continueBoard: document.getElementById('continue-board-btn'),
                startGame: document.getElementById('start-game-btn'),
                backToSet: document.getElementById('back-to-set-btn'),
                backToBoardSelect: document.getElementById('back-to-board-select-btn'),
                backToMode: document.getElementById('back-to-mode-btn'),
            };
            const selectionCards = document.querySelectorAll('.selection-card');
            const boardCards = document.querySelectorAll('.board-card');
            const colorSwatches = document.querySelectorAll('.color-swatch');
            const modeCards = document.querySelectorAll('.mode-card');
            
            const arContainer = document.getElementById('ar-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const gameStatusEl = document.getElementById('game-status');
            const versionDisplay = document.getElementById('app-version');
            const scanningUI = document.getElementById('scanning-ui');
            
            // User choices
            let selectedSet = null;
            let selectedBoard = null;
            let sceneEl = null;
            
            versionDisplay.textContent = `v${APP_VERSION}`;
            
            const CACHE_NAME = `ajedrez-ar-cache-v${APP_VERSION}`;

            // Asset mapping for 3D models.
            // MEJORA: Se cambiaron las URLs de raw.githubusercontent.com a cdn.jsdelivr.net
            // Esto asegura que los modelos se sirvan con el tipo MIME correcto (model/gltf-binary)
            // y resuelve el principal problema de carga de recursos.
            const assetMap = {
                'harry-potter': {
                    w: {
                        p: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Pawn_Gryffindor.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        r: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Rook_Dobby.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        n: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Knight_RWeasley.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        b: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Bishop_HPotter.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        q: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Queen_Hermione.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        k: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/King_Dumbledore.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                    },
                    b: {
                        p: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Pawn_Sytherin.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        r: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Rook_Dobby2.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        n: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Knight_RWeasley.glb', scale: '0.05 0.05 0.05', rotation: '0 180 0' },
                        b: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Bishop_HPotter_Hollow.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                        q: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/Queen_Hermione.glb', scale: '0.05 0.05 0.05', rotation: '0 180 0' },
                        k: { url: 'https://cdn.jsdelivr.net/gh/instructorandradedcc/Ecoajedres-AR@main/King_Voldemort.glb', scale: '0.05 0.05 0.05', rotation: '0 0 0' },
                    }
                }
            };

            // ---- Navigation Logic ----
            function navigateTo(screenName) {
                if (sceneEl) {
                    const mindarSystem = sceneEl.systems['mindar-image-system'];
                    if (mindarSystem) {
                        mindarSystem.stop();
                         if (mindarSystem.video) {
                            mindarSystem.video.srcObject.getTracks().forEach(track => track.stop());
                        }
                    }
                    sceneEl.pause();
                    arContainer.innerHTML = '';
                    sceneEl = null;
                }
                document.documentElement.classList.remove('ar-active');
                document.body.classList.remove('ar-active');

                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) screens[screenName].classList.add('active');

                buttons.backToMode.style.display = 'none';
                gameStatusEl.style.display = 'none';
            }

            buttons.start.addEventListener('click', () => navigateTo('selection'));
            buttons.backToSet.addEventListener('click', () => navigateTo('selection'));
            buttons.backToBoardSelect.addEventListener('click', () => navigateTo('boardSelection'));
            buttons.backToMode.addEventListener('click', () => {
                game.reset();
                navigateTo('gameMode');
            });
            
            selectionCards.forEach(card => card.addEventListener('click', () => {
                selectionCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedSet = card.dataset.set;
                buttons.continueSet.disabled = false;
            }));

            buttons.continueSet.addEventListener('click', () => { if (selectedSet) navigateTo('boardSelection'); });

            boardCards.forEach(card => card.addEventListener('click', () => {
                boardCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedBoard = card.dataset.board;
                validateStep2();
            }));

            colorSwatches.forEach(swatch => swatch.addEventListener('click', () => {
                colorSwatches.forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected');
                playerColor = swatch.dataset.color;
                validateStep2();
            }));
            
            function validateStep2() { buttons.continueBoard.disabled = !(selectedBoard && playerColor); }

            buttons.continueBoard.addEventListener('click', () => { if (selectedBoard && playerColor) navigateTo('gameMode'); });

            modeCards.forEach(card => card.addEventListener('click', () => {
                modeCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                gameMode = card.dataset.mode;
                buttons.startGame.disabled = false;
            }));

            buttons.startGame.addEventListener('click', async () => {
                if(gameMode) {
                    navigateTo('ar');
                    showLoading(true, "Cargando recursos...");
                    await preloadARAssets(); // Espera a que los recursos est√©n listos
                    showLoading(true, "Iniciando c√°mara...");
                    setupARScene();
                }
            });

            function showLoading(on, message = "") {
                const loadingMessage = document.getElementById('loading-message');
                if (on) {
                    loadingMessage.textContent = message;
                    loadingOverlay.style.display = 'flex';
                } else {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            // ---- Caching and Asset Preloading ----
            async function fetchAndCache(url) {
                try {
                    const cache = await caches.open(CACHE_NAME);
                    const cachedResponse = await cache.match(url);
                    if (cachedResponse) return; // Ya est√° en cach√©
                    
                    const networkResponse = await fetch(url);
                    if (networkResponse.ok) {
                        await cache.put(url, networkResponse);
                    } else {
                         console.error(`Error al buscar el recurso: ${networkResponse.status} ${networkResponse.statusText} for ${url}`);
                    }
                } catch (error) {
                    console.error(`Fallo la carga o cacheo del recurso ${url}:`, error);
                }
            }

            async function preloadARAssets() {
                if (!assetMap[selectedSet]) return;

                const urls = new Set();
                Object.values(assetMap[selectedSet].w).forEach(p => urls.add(p.url));
                Object.values(assetMap[selectedSet].b).forEach(p => urls.add(p.url));

                const promises = Array.from(urls).map(url => fetchAndCache(url));
                await Promise.all(promises);
            }

            // ---- AR and Game Logic ----
            function setupARScene() {
                document.documentElement.classList.add('ar-active');
                document.body.classList.add('ar-active');

                sceneEl = document.createElement('a-scene');
                sceneEl.setAttribute('mindar-image', 'imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card/card.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;');
                sceneEl.setAttribute('color-space', 'sRGB');
                sceneEl.setAttribute('renderer', 'colorManagement: true, physicallyCorrectLights');
                sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
                sceneEl.setAttribute('device-orientation-permission-ui', 'enabled: false');
                sceneEl.setAttribute('embedded','');

                const assetsEl = document.createElement('a-assets');
                if (assetMap[selectedSet]) {
                    const urls = new Set();
                    Object.values(assetMap[selectedSet].w).forEach(p => urls.add(p.url));
                    Object.values(assetMap[selectedSet].b).forEach(p => urls.add(p.url));
                    urls.forEach(url => {
                        const assetItem = document.createElement('a-asset-item');
                        assetItem.setAttribute('id', url);
                        assetItem.setAttribute('src', url);
                        assetItem.setAttribute('response-type', 'arraybuffer');
                        assetsEl.appendChild(assetItem);
                    });
                }
                sceneEl.appendChild(assetsEl);
                
                const cameraEl = document.createElement('a-camera');
                cameraEl.setAttribute('position', '0 0 0');
                cameraEl.setAttribute('look-controls', 'enabled: false');
                sceneEl.appendChild(cameraEl);

                const targetEntity = document.createElement('a-entity');
                targetEntity.setAttribute('mindar-image-target', 'targetIndex: 0');
                
                const boardEntity = document.createElement('a-entity');
                boardEntity.setAttribute('gesture-handler', ''); // Add gesture controls
                create3DBoard(boardEntity);
                renderBoardFromFen(boardEntity);
                targetEntity.appendChild(boardEntity);
                
                sceneEl.appendChild(targetEntity);
                arContainer.appendChild(sceneEl);

                sceneEl.addEventListener('loaded', () => {
                    const mindarSystem = sceneEl.systems['mindar-image-system'];
                    mindarSystem.start();
                });

                sceneEl.addEventListener('arReady', () => {
                    showLoading(false);
                    buttons.backToMode.style.display = 'block';
                    gameStatusEl.style.display = 'block';
                    scanningUI.classList.remove('hidden');
                });
                
                sceneEl.addEventListener('targetFound', () => scanningUI.classList.add('hidden'));
                sceneEl.addEventListener('targetLost', () => scanningUI.classList.remove('hidden'));

                // El listener de click se debe a√±adir a la escena, no a las piezas individuales.
                sceneEl.addEventListener('click', handleSceneClick);
                updateGameStatus();
            }

            function create3DBoard(parent) {
                const boardSize = 1.4;
                const squareSize = boardSize / 8;
                const boardGroup = document.createElement('a-entity');
                boardGroup.setAttribute('id', 'board-group');
                
                // Base del tablero
                const boardBase = document.createElement('a-box');
                boardBase.setAttribute('width', boardSize + 0.1);
                boardBase.setAttribute('height', 0.04);
                boardBase.setAttribute('depth', boardSize + 0.1);
                boardBase.setAttribute('color', '#4a2a15');
                boardBase.setAttribute('position', `0 -0.03 0`);
                boardGroup.appendChild(boardBase);

                for(let i = 0; i < 8; i++) {
                    for(let j = 0; j < 8; j++) {
                        const squareEl = document.createElement('a-plane');
                        squareEl.setAttribute('width', squareSize);
                        squareEl.setAttribute('height', squareSize);
                        const color = (i + j) % 2 === 0 ? '#D18B47' : '#FFCE9E';
                        squareEl.setAttribute('color', color);
                        const x = -boardSize/2 + squareSize/2 + j * squareSize;
                        const z = -boardSize/2 + squareSize/2 + i * squareSize;
                        squareEl.setAttribute('position', `${x} 0.001 ${z}`);
                        squareEl.setAttribute('rotation', '-90 0 0');
                        squareEl.dataset.square = 'abcdefgh'[j] + (8 - i);
                        squareEl.classList.add('clickable-square');
                        boardGroup.appendChild(squareEl);
                    }
                }
                parent.appendChild(boardGroup);
            }
            
            function renderBoardFromFen(parent) {
                parent.querySelectorAll('.chess-piece').forEach(el => el.remove());
                const boardSize = 1.4;
                const squareSize = boardSize / 8;
                const offset = -boardSize/2 + squareSize/2;
                
                game.board().forEach((row, i) => {
                    row.forEach((piece, j) => {
                        if (!piece) return;
                        
                        const pieceEl = document.createElement('a-entity');
                        pieceEl.classList.add('chess-piece');
                        pieceEl.dataset.square = piece.square;
                        pieceEl.dataset.pieceInfo = `${piece.color}${piece.type}`;

                        if (assetMap[selectedSet]?.[piece.color]?.[piece.type]) {
                            const modelData = assetMap[selectedSet][piece.color][piece.type];
                            pieceEl.setAttribute('gltf-model', `#${modelData.url}`);
                            pieceEl.setAttribute('scale', modelData.scale);
                            pieceEl.setAttribute('rotation', modelData.rotation);
                        } else { // Fallback a primitivas
                            const primitive = getPrimitive(piece.type, piece.color);
                            pieceEl.setAttribute('geometry', primitive.geometry);
                            pieceEl.setAttribute('material', primitive.material);
                        }
                        
                        const x = offset + j * squareSize;
                        const z = offset + i * squareSize;
                        pieceEl.setAttribute('position', `${x} 0.05 ${z}`);
                        parent.appendChild(pieceEl);
                    });
                });
            }

            function handleSceneClick(evt) {
                if ((gameMode === 'pva' && game.turn() !== playerColor) || game.game_over()) return;

                const clickedEl = evt.target;
                
                if (gameState === 'IDLE') {
                    // Si el click fue en una pieza
                    if (clickedEl.classList.contains('chess-piece')) {
                        const square = clickedEl.dataset.square;
                        const piece = game.get(square);
                        if (piece && piece.color === game.turn()) {
                            selectPiece(clickedEl);
                        }
                    }
                } else if (gameState === 'PIECE_SELECTED') {
                    let toSquare = null;
                    if (clickedEl.classList.contains('clickable-square')) {
                        toSquare = clickedEl.dataset.square;
                    } else if (clickedEl.classList.contains('chess-piece')) {
                        // Permite capturar una pieza clickeando en ella.
                        toSquare = clickedEl.dataset.square;
                    } else if (clickedEl.classList.contains('legal-move-marker')) {
                        toSquare = clickedEl.dataset.square;
                    }

                    if (toSquare) {
                        const fromSquare = selectedPieceEntity.dataset.square;
                        const move = game.move({ from: fromSquare, to: toSquare, promotion: 'q' });
                        
                        if (move) {
                            movePiece();
                        } else {
                            // Si el click es en otra pieza del mismo color, la selecciona.
                            const piece = game.get(toSquare);
                            if (piece && piece.color === game.turn()) {
                                selectPiece(document.querySelector(`.chess-piece[data-square="${toSquare}"]`));
                            } else {
                                clearLegalMoves();
                                gameState = 'IDLE';
                            }
                        }
                    } else {
                        clearLegalMoves();
                        gameState = 'IDLE';
                    }
                }
            }

            function selectPiece(entity) {
                clearLegalMoves();
                selectedPieceEntity = entity;
                gameState = 'PIECE_SELECTED';
                
                const moves = game.moves({ square: entity.dataset.square, verbose: true });
                moves.forEach(move => {
                    const pos = squareToPosition(move.to);
                    const marker = document.createElement('a-cylinder');
                    marker.setAttribute('radius', 0.07);
                    marker.setAttribute('height', 0.01);
                    marker.setAttribute('material', 'color: green; opacity: 0.5');
                    marker.setAttribute('position', `${pos.x} 0.005 ${pos.z}`);
                    marker.dataset.square = move.to;
                    marker.classList.add('legal-move-marker');
                    sceneEl.querySelector('#board-group').appendChild(marker);
                    legalMoveEntities.push(marker);
                });
            }

            function clearLegalMoves() {
                legalMoveEntities.forEach(e => e.parentNode.removeChild(e));
                legalMoveEntities = [];
            }
            
            function movePiece() {
                clearLegalMoves();
                gameState = 'IDLE';
                renderBoardFromFen(sceneEl.querySelector('#board-group'));
                updateGameStatus();

                if (game.game_over()) return;

                if (gameMode === 'pva' && game.turn() !== playerColor) {
                    setTimeout(makeAIMove, 500);
                }
            }
            
            function makeAIMove() {
                const moves = game.moves();
                if (moves.length === 0) return;
                const move = moves[Math.floor(Math.random() * moves.length)];
                game.move(move);
                movePiece();
            }

            function updateGameStatus() {
                let status = '';
                const moveColor = game.turn() === 'w' ? 'Blancas' : 'Negras';

                if (game.in_checkmate()) {
                    status = `¬°Jaque Mate! Ganan las ${moveColor === 'Blancas' ? 'Negras' : 'Blancas'}`;
                } else if (game.in_draw()) {
                    status = 'Empate';
                } else {
                    status = `Turno de las ${moveColor}`;
                    if (game.in_check()) {
                        status += ' - ¬°Jaque!';
                    }
                }
                gameStatusEl.textContent = status;
            }

            function squareToPosition(square) {
                const boardSize = 1.4;
                const squareSize = boardSize / 8;
                const offset = -boardSize/2 + squareSize/2;
                const col = 'abcdefgh'.indexOf(square[0]);
                const row = 8 - parseInt(square[1]);
                return { x: offset + col * squareSize, z: offset + row * squareSize };
            }

            function getPrimitive(type, color) {
                const style = {
                    p_w: { geometry: 'primitive: cylinder; height: 0.1; radius: 0.04', material: 'color: #E5E7EB' },
                    r_w: { geometry: 'primitive: box; width: 0.1; height: 0.12; depth: 0.1', material: 'color: #E5E7EB' },
                    n_w: { geometry: 'primitive: cone; radiusBottom: 0.05; height: 0.15', material: 'color: #E5E7EB' },
                    b_w: { geometry: 'primitive: cylinder; height: 0.18; radiusTop: 0.01; radiusBottom: 0.05', material: 'color: #E5E7EB' },
                    q_w: { geometry: 'primitive: sphere; radius: 0.08', material: 'color: #FBBF24' },
                    k_w: { geometry: 'primitive: dodecahedron; radius: 0.1', material: 'color: #FDE68A' },
                    p_b: { geometry: 'primitive: cylinder; height: 0.1; radius: 0.04', material: 'color: #4B5563' },
                    r_b: { geometry: 'primitive: box; width: 0.1; height: 0.12; depth: 0.1', material: 'color: #4B5563' },
                    n_b: { geometry: 'primitive: cone; radiusBottom: 0.05; height: 0.15', material: 'color: #4B5563' },
                    b_b: { geometry: 'primitive: cylinder; height: 0.18; radiusTop: 0.01; radiusBottom: 0.05', material: 'color: #4B5563' },
                    q_b: { geometry: 'primitive: sphere; radius: 0.08', material: 'color: #6B7280' },
                    k_b: { geometry: 'primitive: dodecahedron; radius: 0.1', material: 'color: #1F2937' }
                };
                return style[`${type}_${color}`] || style['p_w'];
            }
            
            AFRAME.registerComponent('gesture-handler', {
                init: function () {
                    this.scale = 1; this.rotationY = 0;
                    this.el.sceneEl.addEventListener('touchstart', this.handleTouchStart.bind(this));
                    this.el.sceneEl.addEventListener('touchmove', this.handleTouchMove.bind(this));
                    this.el.sceneEl.addEventListener('touchend', this.handleTouchEnd.bind(this));
                    this.touchStart = {};
                },
                handleTouchStart: function (e) {
                    if (e.touches.length === 2) {
                        this.touchStart.distance = this.getDistance(e.touches[0], e.touches[1]);
                        this.touchStart.angle = this.getAngle(e.touches[0], e.touches[1]);
                    }
                },
                handleTouchMove: function (e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const newDistance = this.getDistance(e.touches[0], e.touches[1]);
                        this.scale *= newDistance / this.touchStart.distance;
                        this.el.object3D.scale.set(this.scale, this.scale, this.scale);
                        this.touchStart.distance = newDistance;

                        const newAngle = this.getAngle(e.touches[0], e.touches[1]);
                        this.rotationY += newAngle - this.touchStart.angle;
                        this.el.object3D.rotation.y = this.rotationY;
                        this.touchStart.angle = newAngle;
                    }
                },
                handleTouchEnd: function () { this.touchStart = {}; },
                getDistance: (t1, t2) => Math.hypot(t1.pageX - t2.pageX, t1.pageY - t2.pageY),
                getAngle: (t1, t2) => Math.atan2(t2.pageY - t1.pageY, t2.pageX - t1.pageX)
            });

            window.addEventListener('resize', () => {
                if (sceneEl && sceneEl.renderer) {
                    sceneEl.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
        });
    </script>
</body>
</html>








