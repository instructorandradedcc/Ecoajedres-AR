<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duelo de Magos: Ajedrez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* Estilos generales */
        body { overscroll-behavior: none; }
        html.ar-active, body.ar-active { overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; }
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; overflow-y: auto; transition: opacity 0.5s ease-in-out; z-index: 10; }
        .screen.active { display: flex; }
        .selection-card, .board-card, .color-swatch, .mode-card { transition: all 0.3s ease; border: 4px solid transparent; }
        .selection-card.selected, .board-card.selected, .color-swatch.selected, .mode-card.selected { border-color: #FBBF24; transform: scale(1.05); }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .version { position: fixed; bottom: 10px; right: 10px; color: #9ca3af; font-size: 0.8rem; z-index: 100; }
        .game-status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; z-index: 100; font-size: 1.2rem; display: none; }
        #ar-instructions-ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9991; display: flex; justify-content: center; align-items: center; pointer-events: none; background-color: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.2rem; transition: opacity 0.3s; }
        #ar-instructions-ui.hidden { opacity: 0; pointer-events: none; }
        
        .a-enter-vr-button {
            position: fixed !important; bottom: 20px !important; left: 50% !important;
            transform: translateX(-50%) !important; background-color: #10B981 !important;
            color: white !important; border: none !important; border-radius: 9999px !important;
            padding: 0.75rem 2.5rem !important; font-weight: bold !important; font-size: 1.125rem !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1) !important;
        }
        
        #initial-loading-screen { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://placehold.co/1200x800/1c1917/f5f5f4?text=Fondo+Medieval'); background-size: cover; background-position: center; }
        #progress-bar-container { width: 80%; max-width: 500px; height: 20px; background-color: #4a2a15; border-radius: 10px; border: 2px solid #e2b467; overflow: hidden; position: relative; }
        #progress-bar { width: 0%; height: 100%; background-color: #fBBF24; transition: width 0.5s ease; }
        #progress-icon { font-size: 32px; position: absolute; top: 50%; transform: translateY(-50%) translateX(-50%); left: 0%; transition: left 0.5s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

        /* NUEVA PANTALLA DE CARGA PARA LA C√ÅMARA */
        #ar-entry-loading-screen {
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9));
            z-index: 9990;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulsing-icon { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-stone-900 text-white">
    <div id="app-version" class="version"></div>
    <div id="game-status" class="game-status"></div>

    <div id="welcome-screen" class="screen active flex-col justify-center items-center text-center p-8 bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://placehold.co/1200x800/1c1917/f5f5f4?text=Ajedrez+M√°gico');">
        <h1 class="text-5xl md:text-7xl font-extrabold mb-4 text-amber-300 drop-shadow-lg">Duelo de Ajedrez M√°gico</h1>
        <p class="text-lg md:text-xl max-w-2xl mb-8 text-stone-200">Invoca un tablero de ajedrez 3D en tu propio entorno.</p>
        <button id="start-btn" class="bg-amber-400 text-stone-900 font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:bg-amber-300 transition-transform transform hover:scale-105">Empezar Duelo</button>
    </div>
    
    <div id="initial-loading-screen" class="screen flex-col justify-center items-center text-center p-8">
        <h2 id="loading-title" class="text-4xl font-bold mb-4 text-amber-300">Preparando el Campo de Batalla</h2>
        <div id="progress-bar-container" class="mb-4"><div id="progress-bar"></div><div id="progress-icon">‚ôò</div></div>
        <p id="loading-text" class="text-stone-300 max-w-xl mb-6">Comprobando arsenal...</p>
    </div>

    <div id="selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Selecciona tu Ej√©rcito</h2><p class="text-stone-300">Elige el estilo de piezas para tu partida.</p></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="harry-potter"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßô‚Äç‚ôÇÔ∏è</div><h3 class="text-2xl font-semibold mb-2">Ajedrez M√°gico</h3><p class="text-stone-400">Piezas inspiradas en el mundo de los magos.</p></div>
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="futuristic"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center"><span class="text-8xl">‚ôú</span></div><h3 class="text-2xl font-semibold mb-2">Vanguardia Futurista</h3><p class="text-stone-400">Dise√±o moderno y disruptivo.</p></div>
        </div>
        <button id="continue-set-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 transition-all shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
    </div>
    
    <div id="board-selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Personaliza tu Partida</h2><p class="text-stone-300">Elige tu tablero y el color de tus piezas.</p></div>
        <div class="max-w-4xl w-full">
            <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige un tablero</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-wood"><img src="https://placehold.co/400x300/854d0e/fefce8?text=Madera+Cl√°sica" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de madera cl√°sica"><p>Madera Cl√°sica</p></div>
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-marble"><img src="https://placehold.co/400x300/d1d5db/1f2937?text=M√°rmol+Elegante" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de m√°rmol elegante"><p>M√°rmol Elegante</p></div>
            </div>
            <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige el color de tus tropas</h3>
            <div class="flex justify-center gap-6"><div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-white" data-color="w"></div><div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-gray-800" data-color="b"></div></div>
        </div>
        <button id="continue-board-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
        <button id="back-to-set-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <div id="game-mode-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Modo de Duelo</h2><p class="text-stone-300">¬øC√≥mo quieres jugar?</p></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pva"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">ü§ñ</div><h3 class="text-2xl font-semibold">Estratega Solitario (vs. Or√°culo)</h3></div>
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pvp"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßë‚Äçü§ù‚Äçüßë</div><h3 class="text-2xl font-semibold">Duelo de Leyendas (1 vs. 1)</h3></div>
        </div>
        <button id="start-game-btn" class="mt-12 bg-green-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-green-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
        <button id="back-to-board-select-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <div id="instructions-screen" class="screen flex-col justify-center items-center text-center p-8 bg-stone-800">
        <h2 class="text-4xl font-bold mb-4 text-amber-300">Prepara tu Espacio de Juego</h2>
        <p class="text-stone-300 max-w-xl mb-6">El portal m√°gico necesita detectar una superficie plana y bien iluminada.</p>
        <div class="text-6xl mb-4">üì±</div>
        <p class="text-stone-300 max-w-xl mb-8">Cuando aparezca el bot√≥n para "INVOCAR", presi√≥nalo. Luego mueve tu c√°mara lentamente sobre una mesa o el suelo hasta que veas un ret√≠culo, y toca la pantalla para materializar el tablero.</p>
        <button id="start-ar-btn" class="bg-green-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-green-400 shadow-lg">Entrar al Portal</button>
        <button id="back-to-mode-select-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <div id="ar-entry-loading-screen" class="screen flex-col justify-center items-center text-center p-8">
        <h2 class="text-4xl font-bold mb-4 text-amber-300">Abriendo el Portal...</h2>
        <div class="text-8xl mb-6 pulsing-icon">‚ôñ</div>
        <p class="text-stone-300 max-w-xl">Prepara tu vista m√°gica. Puede que necesites conceder permiso para usarla.</p>
    </div>

    <div id="ar-screen" class="screen flex-col justify-center items-center bg-transparent">
        <div id="ar-container"></div>
        <div id="ar-ui-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none">
            <button id="exit-ar-btn" class="absolute top-5 left-5 bg-stone-700/70 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600 z-30 pointer-events-auto" style="display: none;">Rendirse</p>
            <div id="ar-instructions-ui" class="hidden">
                <p id="ar-instructions-text">Mueve tu dispositivo para encontrar una superficie.</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.12.0/chess.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = "2.4.0"; // Versi√≥n con fix de cach√© y UI mejorada
            const CACHE_NAME = `ajedrez-ar-cache-v${APP_VERSION}`;

            let game = new Chess();
            let gameState = 'IDLE';
            let selectedPieceEntity = null;
            let legalMoveEntities = [];
            let playerColor = 'w';
            let gameMode = 'pva';
            
            const screens = {
                welcome: document.getElementById('welcome-screen'),
                initialLoading: document.getElementById('initial-loading-screen'),
                selection: document.getElementById('selection-screen'),
                boardSelection: document.getElementById('board-selection-screen'),
                gameMode: document.getElementById('game-mode-screen'),
                instructions: document.getElementById('instructions-screen'),
                arEntryLoading: document.getElementById('ar-entry-loading-screen'), // Nueva pantalla
                ar: document.getElementById('ar-screen'),
            };
            const buttons = {
                start: document.getElementById('start-btn'),
                continueSet: document.getElementById('continue-set-btn'),
                continueBoard: document.getElementById('continue-board-btn'),
                startGame: document.getElementById('start-game-btn'),
                startAR: document.getElementById('start-ar-btn'),
                backToSet: document.getElementById('back-to-set-btn'),
                backToBoardSelect: document.getElementById('back-to-board-select-btn'),
                backToModeSelect: document.getElementById('back-to-mode-select-btn'),
                exitAR: document.getElementById('exit-ar-btn'),
            };
            
            const arContainer = document.getElementById('ar-container');
            const gameStatusEl = document.getElementById('game-status');
            const versionDisplay = document.getElementById('app-version');
            const arInstructionsUI = document.getElementById('ar-instructions-ui');
            const arInstructionsText = document.getElementById('ar-instructions-text');
            const loadingText = document.getElementById('loading-text');
            const progressBar = document.getElementById('progress-bar');
            const progressIcon = document.getElementById('progress-icon');
            
            let selectedSet = null;
            let selectedBoard = null;
            let sceneEl = null;
            let boardPlaced = false;
            
            versionDisplay.textContent = `v${APP_VERSION}`;
            
            const assetMap = {
                'harry-potter': {
                    w: { p: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Pawn_Gryffindor.glb', scale: '0.02 0.02 0.02' }, r: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Rook_Dobby.glb', scale: '0.02 0.02 0.02' }, n: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Knight_RWeasley.glb', scale: '0.02 0.02 0.02' }, b: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Bishop_HPotter.glb', scale: '0.02 0.02 0.02' }, q: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Queen_Hermione.glb', scale: '0.02 0.02 0.02' }, k: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/King_Dumbledore.glb', scale: '0.02 0.02 0.02' } },
                    b: { p: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Pawn_Sytherin.glb', scale: '0.02 0.02 0.02' }, r: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Rook_Dobby2.glb', scale: '0.02 0.02 0.02' }, n: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Knight_RWeasley.glb', scale: '0.02 0.02 0.02', rotation: '0 180 0' }, b: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Bishop_HPotter_Hollow.glb', scale: '0.02 0.02 0.02' }, q: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/Queen_Hermione.glb', scale: '0.02 0.02 0.02', rotation: '0 180 0' }, k: { url: 'https://raw.githack.com/instructorandradedcc/Ecoajedres-AR/main/King_Voldemort.glb', scale: '0.02 0.02 0.02' } }
                }
                // A√±adir set "futuristic" aqu√≠ si tienes los modelos
            };

            // ---- L√≥gica de Navegaci√≥n y Carga ----
            function navigateTo(screenName) {
                if (sceneEl) {
                    sceneEl.pause();
                    if (sceneEl.is('vr-mode')) sceneEl.exitVR();
                    arContainer.innerHTML = '';
                    sceneEl = null;
                }
                document.documentElement.classList.remove('ar-active');
                document.body.classList.remove('ar-active');
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');
            }

            buttons.start.addEventListener('click', () => {
                navigateTo('initialLoading');
                initializeApp();
            });

            async function initializeApp() {
                const loadingMessages = ["Forjando armaduras...", "Consultando grimorios...", "Afilando espadas...", "Invocando el tablero...", "Desplegando tropas..."];
                let msgInterval = setInterval(() => {
                    loadingText.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
                }, 1500);

                const assetsInCache = await checkCache();
                if (assetsInCache) {
                    loadingText.textContent = "¬°Recursos encontrados! Iniciando...";
                    updateProgress(100);
                } else {
                    await downloadAndCacheAssets();
                }

                clearInterval(msgInterval);
                cleanOldCaches();
                
                setTimeout(() => navigateTo('selection'), 1000);
            }
            
            function updateProgress(percentage) {
                progressBar.style.width = `${percentage}%`;
                progressIcon.style.left = `${percentage}%`;
            }

            async function checkCache() {
                try {
                    if (!('caches' in window)) return false;
                    const cache = await caches.open(CACHE_NAME);
                    const urls = getAllAssetUrls();
                    for (const url of urls) {
                        const response = await cache.match(url);
                        if (!response || !response.ok) return false;
                    }
                    return true;
                } catch (e) { console.error("Error checking cache:", e); return false; }
            }
            
            function getAllAssetUrls() {
                const urls = new Set();
                Object.values(assetMap).forEach(set => {
                    Object.values(set.w).forEach(p => urls.add(p.url));
                    Object.values(set.b).forEach(p => urls.add(p.url));
                });
                return Array.from(urls);
            }

            async function downloadAndCacheAssets() {
                if (!('caches' in window)) {
                    console.warn("Cache API not available. Assets will be loaded directly.");
                    updateProgress(100); // Simula la carga
                    return;
                }
                const cache = await caches.open(CACHE_NAME);
                const urls = getAllAssetUrls();
                let loadedCount = 0;
                
                const promises = urls.map(async (url) => {
                    try {
                        // **FIX**: Crear una request en modo 'cors' para evitar bloqueos
                        const request = new Request(url, { mode: 'cors' });
                        const response = await fetch(request);
                        if (!response.ok) throw new Error(`Failed to fetch: ${url} with status ${response.status}`);
                        await cache.put(request, response.clone());
                    } catch (error) {
                        console.error(`Failed to download or cache ${url}:`, error);
                    } finally {
                        loadedCount++;
                        updateProgress((loadedCount / urls.length) * 100);
                    }
                });
                await Promise.all(promises);
            }

            async function cleanOldCaches() {
                if (!('caches' in window)) return;
                const keys = await caches.keys();
                const promises = keys.map(key => {
                    if (key.startsWith('ajedrez-ar-cache-v') && key !== CACHE_NAME) {
                        return caches.delete(key);
                    }
                });
                await Promise.all(promises);
            }

            // ---- Resto de la navegaci√≥n (sin cambios) ----
            document.querySelectorAll('.selection-card').forEach(card => card.addEventListener('click', (e) => {
                document.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                selectedSet = e.currentTarget.dataset.set;
                buttons.continueSet.disabled = false;
            }));
            buttons.continueSet.addEventListener('click', () => navigateTo('boardSelection'));
            buttons.backToSet.addEventListener('click', () => navigateTo('selection'));
            buttons.backToBoardSelect.addEventListener('click', () => navigateTo('boardSelection'));
            buttons.backToModeSelect.addEventListener('click', () => navigateTo('gameMode'));
            buttons.exitAR.addEventListener('click', () => { game.reset(); navigateTo('gameMode'); });

            document.querySelectorAll('.board-card').forEach(card => card.addEventListener('click', (e) => {
                document.querySelectorAll('.board-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                selectedBoard = e.currentTarget.dataset.board;
                if (playerColor) buttons.continueBoard.disabled = false;
            }));
             document.querySelectorAll('.color-swatch').forEach(swatch => swatch.addEventListener('click', (e) => {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                playerColor = e.currentTarget.dataset.color;
                if (selectedBoard) buttons.continueBoard.disabled = false;
            }));
            buttons.continueBoard.addEventListener('click', () => navigateTo('gameMode'));
            document.querySelectorAll('.mode-card').forEach(card => card.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                gameMode = e.currentTarget.dataset.mode;
                buttons.startGame.disabled = false;
            }));
            buttons.startGame.addEventListener('click', () => navigateTo('instructions'));
            
            buttons.startAR.addEventListener('click', () => {
                navigateTo('arEntryLoading'); // Mostrar la nueva pantalla de carga
                setTimeout(() => { // Dar un respiro al UI antes de la carga pesada
                    navigateTo('ar');
                    setupARScene();
                }, 1500);
            });

            // ---- L√≥gica de AR con WebXR ----
            function setupARScene() {
                document.documentElement.classList.add('ar-active');
                document.body.classList.add('ar-active');
                boardPlaced = false;

                let assetsContent = '';
                if (assetMap[selectedSet]) {
                    const urls = new Set();
                    Object.values(assetMap[selectedSet].w).forEach(p => urls.add(p.url));
                    Object.values(assetMap[selectedSet].b).forEach(p => urls.add(p.url));
                    urls.forEach(url => {
                        assetsContent += `<a-asset-item id="${url}" src="${url}" crossorigin="anonymous" response-type="arraybuffer"></a-asset-item>`;
                    });
                }
                
                arContainer.innerHTML = `
                    <a-scene id="ar-scene" vr-mode-ui="enabled: true; enterARButtonText: INVOCAR TABLERO" webxr="requiredFeatures: hit-test,local-floor; optionalFeatures: dom-overlay; overlayElement: #ar-ui-overlay" ar-logic renderer="colorManagement: true">
                        <a-assets timeout="30000">${assetsContent}</a-assets>
                        <a-camera></a-camera>
                        <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
                        <a-light type="directional" position="-1 2 1" intensity="0.6"></a-light>
                        <a-entity id="board-container" visible="false"></a-entity>
                        <a-entity id="reticle" ar-hit-test="target: #board-container; type: plane" 
                            geometry="primitive: ring; radiusInner: 0.08; radiusOuter: 0.12" 
                            material="color: #FBBF24; shader: flat;" visible="false"></a-entity>
                    </a-scene>
                `;
                sceneEl = document.querySelector('#ar-scene');
                
                // Esperar a que la escena se cargue para evitar errores de inicializaci√≥n
                sceneEl.addEventListener('loaded', () => {
                    console.log("A-Frame scene loaded successfully.");
                });
            }

            AFRAME.registerComponent('ar-logic', {
                init: function() {
                    const sceneEl = this.el;
                    const reticle = document.querySelector('#reticle');
                    const boardContainer = document.querySelector('#board-container');
                    this.boardPlaced = false;
                    sceneEl.addEventListener('enter-vr', () => {
                        if (sceneEl.is('ar-mode')) {
                            arInstructionsUI.classList.remove('hidden');
                            buttons.exitAR.style.display = 'block';
                        }
                    });
                    sceneEl.addEventListener('exit-vr', () => {
                        game.reset();
                        navigateTo('gameMode');
                    });
                    reticle.addEventListener('ar-hit-test-achieved', () => {
                        reticle.setAttribute('visible', true);
                        if (!this.boardPlaced) arInstructionsText.textContent = "Toca para materializar el tablero.";
                    });
                    reticle.addEventListener('ar-hit-test-lost', () => {
                        reticle.setAttribute('visible', false);
                    });
                    sceneEl.addEventListener('select', () => {
                        if (!this.boardPlaced && reticle.getAttribute('visible')) {
                            boardContainer.setAttribute('visible', 'true');
                            reticle.setAttribute('visible', 'false');
                            reticle.removeAttribute('ar-hit-test');
                            this.boardPlaced = true;
                            boardPlaced = true;
                            arInstructionsUI.classList.add('hidden');
                            gameStatusEl.style.display = 'block';
                            create3DBoard(boardContainer);
                            renderBoardFromFen(boardContainer);
                            updateGameStatus();
                        }
                    });
                    sceneEl.addEventListener('click', (evt) => {
                        if (this.boardPlaced) handleGameClick(evt);
                    });
                }
            });

            function create3DBoard(parent) {
                const boardSize = 0.6; const squareSize = boardSize / 8;
                const boardGroup = document.createElement('a-entity');
                boardGroup.setAttribute('id', 'board-group');
                const boardBase = document.createElement('a-box');
                boardBase.setAttribute('width', boardSize + 0.04); boardBase.setAttribute('height', 0.02);
                boardBase.setAttribute('depth', boardSize + 0.04); boardBase.setAttribute('color', '#4a2a15');
                boardBase.setAttribute('position', '0 -0.01 0');
                boardGroup.appendChild(boardBase);
                for(let i = 0; i < 8; i++) {
                    for(let j = 0; j < 8; j++) {
                        const squareEl = document.createElement('a-plane');
                        squareEl.setAttribute('width', squareSize); squareEl.setAttribute('height', squareSize);
                        squareEl.setAttribute('color', (i + j) % 2 === 0 ? '#D18B47' : '#FFCE9E');
                        const x = -boardSize/2 + squareSize/2 + j * squareSize;
                        const z = -boardSize/2 + squareSize/2 + i * squareSize;
                        squareEl.setAttribute('position', `${x} 0.001 ${z}`);
                        squareEl.setAttribute('rotation', '-90 0 0');
                        squareEl.dataset.square = 'abcdefgh'[j] + (8 - i);
                        squareEl.classList.add('clickable-square');
                        boardGroup.appendChild(squareEl);
                    }
                }
                parent.appendChild(boardGroup);
            }
            
            function renderBoardFromFen(parent) {
                parent.querySelectorAll('.chess-piece').forEach(el => el.remove());
                const boardSize = 0.6; const squareSize = boardSize / 8;
                const offset = -boardSize/2 + squareSize/2;
                game.board().forEach((row, i) => {
                    row.forEach((piece, j) => {
                        if (!piece) return;
                        const pieceEl = document.createElement('a-entity');
                        pieceEl.classList.add('chess-piece');
                        pieceEl.dataset.square = piece.square;
                        if (assetMap[selectedSet]?.[piece.color]?.[piece.type]) {
                            const modelData = assetMap[selectedSet][piece.color][piece.type];
                            pieceEl.setAttribute('gltf-model', `#${modelData.url}`);
                            pieceEl.setAttribute('scale', modelData.scale);
                            if(modelData.rotation) pieceEl.setAttribute('rotation', modelData.rotation);
                        } else {
                            const primitive = getPrimitive(piece.type, piece.color);
                            pieceEl.setAttribute('geometry', primitive.geometry);
                            pieceEl.setAttribute('material', `color: ${primitive.color}`);
                        }
                        const x = offset + j * squareSize;
                        const z = offset + i * squareSize;
                        pieceEl.setAttribute('position', `${x} 0.02 ${z}`);
                        parent.appendChild(pieceEl);
                    });
                });
            }

            function handleGameClick(evt) {
                if ((gameMode === 'pva' && game.turn() !== playerColor) || game.game_over()) return;
                const clickedEl = evt.target.closest('.chess-piece, .clickable-square, .legal-move-marker');
                if (!clickedEl) { clearLegalMoves(); gameState = 'IDLE'; return; }
                if (gameState === 'IDLE') {
                    if (clickedEl.classList.contains('chess-piece')) {
                        const square = clickedEl.dataset.square;
                        const piece = game.get(square);
                        if (piece && piece.color === game.turn()) selectPiece(clickedEl);
                    }
                } else if (gameState === 'PIECE_SELECTED') {
                    let toSquare = clickedEl.dataset.square;
                    if (toSquare) {
                        const fromSquare = selectedPieceEntity.dataset.square;
                        const move = game.move({ from: fromSquare, to: toSquare, promotion: 'q' });
                        if (move) {
                            movePiece();
                        } else {
                            const piece = game.get(toSquare);
                            if (piece && piece.color === game.turn() && document.querySelector(`.chess-piece[data-square="${toSquare}"]`)) {
                                selectPiece(document.querySelector(`.chess-piece[data-square="${toSquare}"]`));
                            } else { clearLegalMoves(); gameState = 'IDLE'; }
                        }
                    } else { clearLegalMoves(); gameState = 'IDLE'; }
                }
            }

            function selectPiece(entity) {
                clearLegalMoves();
                selectedPieceEntity = entity;
                gameState = 'PIECE_SELECTED';
                const moves = game.moves({ square: entity.dataset.square, verbose: true });
                moves.forEach(move => {
                    const pos = squareToPosition(move.to);
                    const marker = document.createElement('a-cylinder');
                    marker.setAttribute('radius', '0.03'); marker.setAttribute('height', '0.005');
                    marker.setAttribute('material', 'color: #10B981; opacity: 0.6');
                    marker.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
                    marker.dataset.square = move.to;
                    marker.classList.add('legal-move-marker');
                    document.querySelector('#board-group').appendChild(marker);
                    legalMoveEntities.push(marker);
                });
            }

            function clearLegalMoves() {
                legalMoveEntities.forEach(e => e.parentNode.removeChild(e));
                legalMoveEntities = [];
            }
            
            function movePiece() {
                clearLegalMoves(); gameState = 'IDLE';
                renderBoardFromFen(document.querySelector('#board-container'));
                updateGameStatus();
                if (!game.game_over() && gameMode === 'pva' && game.turn() !== playerColor) {
                    setTimeout(makeAIMove, 500);
                }
            }
            
            function makeAIMove() {
                const moves = game.moves();
                if (moves.length > 0) {
                    game.move(moves[Math.floor(Math.random() * moves.length)]);
                    movePiece();
                }
            }

            function updateGameStatus() {
                let status = '';
                const moveColor = game.turn() === 'w' ? 'Blancas' : 'Negras';
                if (game.in_checkmate()) { status = `¬°Jaque Mate! Ganan las ${moveColor === 'Blancas' ? 'Negras' : 'Blancas'}`; } 
                else if (game.in_draw()) { status = 'Empate'; } 
                else { status = `Turno de las ${moveColor}`; if (game.in_check()) status += ' - ¬°Jaque!'; }
                gameStatusEl.textContent = status;
            }

            function squareToPosition(square) {
                 const boardSize = 0.6; const squareSize = boardSize / 8;
                 const offset = -boardSize/2 + squareSize/2;
                 const col = 'abcdefgh'.indexOf(square[0]);
                 const row = 8 - parseInt(square[1]);
                 return { x: offset + col * squareSize, z: offset + row * squareSize, y: 0.005 };
            }

            function getPrimitive(type, color) {
                const colors = { w: '#E5E7EB', b: '#4B5563', w_q: '#FBBF24', w_k: '#FDE68A', b_q: '#6B7280', b_k: '#1F2937' };
                const c = colors[`${color}_${type}`] || colors[color];
                const geo = {
                    p: 'primitive: cylinder; height: 0.04; radius: 0.015',
                    r: 'primitive: box; width: 0.035; height: 0.045; depth: 0.035',
                    n: 'primitive: cone; radiusBottom: 0.02; height: 0.055',
                    b: 'primitive: cylinder; height: 0.06; radiusTop: 0.005; radiusBottom: 0.02',
                    q: 'primitive: sphere; radius: 0.03',
                    k: 'primitive: dodecahedron; radius: 0.035'
                };
                return { geometry: geo[type], color: c };
            }
        });
    </script>
</body>
</html>








